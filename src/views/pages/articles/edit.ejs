<h3 class="fw-bold text-center">Edit Article</h3>

<div class="modal fade" id="articlePreview" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width: 420px;">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Article Preview</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="rounded w-full p-2" style="min-height: 450px; overflow: hidden;">
          <img id="mobile-img" src="<%= data.img_url %>" alt="Preview Image" style="width: 100%;">
          <h5 class="mt-3 mx-2" id="title-mobile" style="overflow-wrap: break-word;">
            <%= data.title %>
          </h5>
          <div class="mx-2" id="content-mobile">
            <%- data.content %>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="bg-white p-4 rounded shadow-sm">

  <button class="btn btn-primary border" data-bs-toggle="modal" data-bs-target="#articlePreview">Preview</button>

  <form class="col" id="form" action="/admin/articles/edit/<%= data.id %>" enctype="multipart/form-data">
    <input type="hidden" name="current_img" value="<%= data.img_url %>">
    <div class="modal-body">
      <!-- IMG -->
      <div class="d-flex mb-3 align-items-center gap-2 flex-wrap flex-column">
        <div class="col text-center">
          <img id="cover-img" src="<%= data.img_url %>" alt="Cover" width="130">
          <br><em class="text-danger" style="font-size: 13px;">*maksimal 1MB</em>
        </div>
        <div class="col-10">
          <input type="file" name="img" accept="image/*" class="form-control" onchange="previewImage(event)">
        </div>
      </div>

      <!-- TITLE -->
      <div class="form-floating mb-3">
        <input onkeyup="titlePreview(event)" value="<%= data.title %>" type="text" name="title" class="form-control"
          placeholder="Course" autocomplete="off" required>
        <label>Title</label>
      </div>


      <div class="col">
        <textarea onchange="contentPreview(event)" name="content" id="editor" placeholder="Type here...">
          <%= data.content %>
        </textarea>
      </div>

    </div>

    <div class="mt-4 d-flex gap-2 modal-footer">
      <a href="/admin/articles" class="btn btn-md btn-danger">Cancel</a>
      <button type="submit" class="btn btn-md btn-warning">Update</button>
    </div>
  </form>
</div>

<script>
  const editor = Jodit.make('#editor')

  $('#form').submit(function (e) {
    e.preventDefault()
    $('button[type="submit"]').prop('disabled', true)
    const formData = new FormData(this)
    $.ajax({
      url: $(this).attr('action'),
      type: 'PUT',
      data: formData,
      processData: false,
      contentType: false,
      success: function (response) {
        swal({
          title: 'Success!',
          text: 'Article Updated',
          icon: 'success',
        }).then((result) => {
          window.location.href = '/admin/articles/show/<%= data.id %>'
        })
      },
      error: function (err) {
        swal({
          title: 'Error!',
          text: 'An error occured',
          icon: 'error'
        })
      }
    })
    $('button[type="submit"]').prop('disabled', false)
  })

  function previewImage(event) {
    const file = event.target.files[0]
    const reader = new FileReader()
    if (file.size >= 1400000) {
      swal({
        title: 'Warning!',
        text: 'Ukuran file terlalu besar. Maksimal 1 MB',
        icon: 'warning'
      })
    }
    reader.onload = function () {
      $('#cover-img').attr('src', reader.result)
      $('#mobile-img').attr('src', reader.result)
    }
    if (file) {
      reader.readAsDataURL(file)
    }
  }

  function titlePreview(event) {
    if (event.target.value === '') {
      $('#title-mobile').html('Title')
    } else {
      $('#title-mobile').html(event.target.value)
    }
  }

  function contentPreview(event) {
    if (event.target.value === '<p><br></p>') {
      $('#content-mobile').html('Content')
    } else {
      $('#content-mobile').html(event.target.value)
    }
  }

</script>